{% extends "base.html" %}

{% block title %}Relatórios - TechSupport Pro{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-chart-bar text-tech-primary mr-3"></i>Relatórios e Análises
            </h1>
            <p class="text-gray-600">Monitore métricas de desempenho e gere relatórios detalhados.</p>
        </div>
        
        <button onclick="exportReport()" class="bg-tech-accent hover:bg-tech-accent-dark text-white px-6 py-3 rounded-lg transition-colors font-medium">
            <i class="fas fa-download mr-2"></i>Exportar CSV
        </button>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100">
                    <i class="fas fa-ticket-alt text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total de Chamados</p>
                    <p class="text-2xl font-semibold text-gray-900" id="metric-total-tickets">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Taxa de Resolução</p>
                    <p class="text-2xl font-semibold text-gray-900" id="metric-resolution-rate">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Cumprimento SLA</p>
                    <p class="text-2xl font-semibold text-gray-900" id="metric-sla-compliance">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Violações SLA</p>
                    <p class="text-2xl font-semibold text-gray-900" id="metric-sla-violations">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-filter text-tech-accent mr-2"></i>Filtros de Relatório
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data Inicial</label>
                <input type="date" id="filter-start-date" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data Final</label>
                <input type="date" id="filter-end-date" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
                    <option value="">Todos</option>
                    <option value="Aberto">Aberto</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Resolvido">Resolvido</option>
                    <option value="Fechado">Fechado</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                <select id="filter-priority" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
                    <option value="">Todas</option>
                    <option value="Alta">Alta</option>
                    <option value="Média">Média</option>
                    <option value="Baixa">Baixa</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                <select id="filter-department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
                    <option value="">Todos</option>
                    <option value="TI">TI</option>
                    <option value="RH">RH</option>
                    <option value="Vendas">Vendas</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Financeiro">Financeiro</option>
                </select>
            </div>
        </div>
        
        <div class="flex justify-between items-center mt-4">
            <button onclick="clearReportFilters()" class="text-gray-600 hover:text-gray-800 transition-colors">
                <i class="fas fa-times-circle mr-1"></i>Limpar Filtros
            </button>
            <button onclick="applyReportFilters()" class="bg-tech-accent hover:bg-tech-accent-dark text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-search mr-2"></i>Aplicar Filtros
            </button>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Tickets by Priority -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-pie text-tech-accent mr-2"></i>Chamados por Prioridade
            </h3>
            <div class="h-64">
                <canvas id="priority-chart"></canvas>
            </div>
        </div>

        <!-- Tickets by Status -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-doughnut text-tech-accent mr-2"></i>Chamados por Status
            </h3>
            <div class="h-64">
                <canvas id="status-chart"></canvas>
            </div>
        </div>

        <!-- Tickets by Department -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-bar text-tech-accent mr-2"></i>Chamados por Departamento
            </h3>
            <div class="h-64">
                <canvas id="department-chart"></canvas>
            </div>
        </div>

        <!-- Monthly Trend -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-line text-tech-accent mr-2"></i>Tendência Mensal
            </h3>
            <div class="h-64">
                <canvas id="monthly-trend-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Top Technicians -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-trophy text-tech-accent mr-2"></i>Técnicos - Desempenho
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Técnico</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resolvidos</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SLA</th>
                        </tr>
                    </thead>
                    <tbody id="technicians-table" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Carregando dados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Department Statistics -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-building text-tech-accent mr-2"></i>Estatísticas por Departamento
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chamados</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tempo Médio</th>
                        </tr>
                    </thead>
                    <tbody id="departments-table" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Carregando dados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-history text-tech-accent mr-2"></i>Atividade Recente
        </h3>
        <div id="recent-activity" class="space-y-3">
            <!-- Recent activity will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFilters = {};
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeDateFilters();
    loadReportData();
});

function initializeDateFilters() {
    const today = new Date();
    const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    document.getElementById('filter-end-date').value = today.toISOString().split('T')[0];
    document.getElementById('filter-start-date').value = lastMonth.toISOString().split('T')[0];
}

async function loadReportData() {
    try {
        showLoading();
        
        // Load dashboard stats for key metrics
        const statsResponse = await axios.get('/api/dashboard/stats');
        const stats = statsResponse.data;
        
        updateKeyMetrics(stats);
        
        // Load tickets for detailed analysis
        const ticketsResponse = await axios.get('/api/tickets?per_page=1000');
        const tickets = ticketsResponse.data.tickets;
        
        generateCharts(tickets);
        generateTables(tickets);
        
    } catch (error) {
        console.error('Error loading report data:', error);
        showToast('Erro ao carregar dados do relatório', 'error');
    } finally {
        hideLoading();
    }
}

function updateKeyMetrics(stats) {
    document.getElementById('metric-total-tickets').textContent = stats.total_tickets;
    
    const resolutionRate = stats.total_tickets > 0 ? 
        Math.round(((stats.resolved_tickets + stats.closed_tickets) / stats.total_tickets) * 100) : 0;
    document.getElementById('metric-resolution-rate').textContent = resolutionRate + '%';
    
    const slaCompliance = stats.total_tickets > 0 ? 
        Math.round(((stats.total_tickets - stats.sla_violations) / stats.total_tickets) * 100) : 100;
    document.getElementById('metric-sla-compliance').textContent = slaCompliance + '%';
    
    document.getElementById('metric-sla-violations').textContent = stats.sla_violations;
}

function generateCharts(tickets) {
    generatePriorityChart(tickets);
    generateStatusChart(tickets);
    generateDepartmentChart(tickets);
    generateMonthlyTrendChart(tickets);
}

function generatePriorityChart(tickets) {
    const priorityCounts = tickets.reduce((acc, ticket) => {
        acc[ticket.priority] = (acc[ticket.priority] || 0) + 1;
        return acc;
    }, {});
    
    const ctx = document.getElementById('priority-chart').getContext('2d');
    
    if (charts.priority) {
        charts.priority.destroy();
    }
    
    charts.priority = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(priorityCounts),
            datasets: [{
                data: Object.values(priorityCounts),
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',   // Red for Alta
                    'rgba(245, 158, 11, 0.8)',  // Yellow for Média
                    'rgba(34, 197, 94, 0.8)'    // Green for Baixa
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function generateStatusChart(tickets) {
    const statusCounts = tickets.reduce((acc, ticket) => {
        acc[ticket.status] = (acc[ticket.status] || 0) + 1;
        return acc;
    }, {});
    
    const ctx = document.getElementById('status-chart').getContext('2d');
    
    if (charts.status) {
        charts.status.destroy();
    }
    
    charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',   // Blue for Aberto
                    'rgba(245, 158, 11, 0.8)',   // Orange for Em Andamento
                    'rgba(34, 197, 94, 0.8)',    // Green for Resolvido
                    'rgba(107, 114, 128, 0.8)'   // Gray for Fechado
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function generateDepartmentChart(tickets) {
    const departmentCounts = tickets.reduce((acc, ticket) => {
        acc[ticket.department] = (acc[ticket.department] || 0) + 1;
        return acc;
    }, {});
    
    const ctx = document.getElementById('department-chart').getContext('2d');
    
    if (charts.department) {
        charts.department.destroy();
    }
    
    charts.department = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(departmentCounts),
            datasets: [{
                label: 'Chamados',
                data: Object.values(departmentCounts),
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function generateMonthlyTrendChart(tickets) {
    // Group tickets by month
    const monthlyData = tickets.reduce((acc, ticket) => {
        const date = new Date(ticket.created_at);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!acc[monthKey]) {
            acc[monthKey] = { created: 0, resolved: 0 };
        }
        
        acc[monthKey].created++;
        
        if (ticket.status === 'Resolvido' || ticket.status === 'Fechado') {
            acc[monthKey].resolved++;
        }
        
        return acc;
    }, {});
    
    const sortedMonths = Object.keys(monthlyData).sort();
    const createdData = sortedMonths.map(month => monthlyData[month].created);
    const resolvedData = sortedMonths.map(month => monthlyData[month].resolved);
    
    const ctx = document.getElementById('monthly-trend-chart').getContext('2d');
    
    if (charts.monthly) {
        charts.monthly.destroy();
    }
    
    charts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: 'Criados',
                data: createdData,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Resolvidos',
                data: resolvedData,
                borderColor: 'rgba(34, 197, 94, 1)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function generateTables(tickets) {
    generateTechniciansTable(tickets);
    generateDepartmentsTable(tickets);
}

function generateTechniciansTable(tickets) {
    // Calculate technician performance
    const techPerformance = tickets.reduce((acc, ticket) => {
        if (ticket.assigned_to) {
            const techId = ticket.assigned_to.id;
            const techName = ticket.assigned_to.username;
            
            if (!acc[techId]) {
                acc[techId] = {
                    name: techName,
                    total: 0,
                    resolved: 0,
                    slaViolations: 0
                };
            }
            
            acc[techId].total++;
            
            if (ticket.status === 'Resolvido' || ticket.status === 'Fechado') {
                acc[techId].resolved++;
            }
            
            if (ticket.sla_violated) {
                acc[techId].slaViolations++;
            }
        }
        
        return acc;
    }, {});
    
    const sortedTechs = Object.values(techPerformance)
        .sort((a, b) => b.resolved - a.resolved);
    
    const tbody = document.getElementById('technicians-table');
    
    if (sortedTechs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                    Nenhum dado de técnico disponível
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = sortedTechs.map(tech => {
        const slaCompliance = tech.total > 0 ? 
            Math.round(((tech.total - tech.slaViolations) / tech.total) * 100) : 100;
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-4 text-sm text-gray-900">${tech.name}</td>
                <td class="px-4 py-4 text-sm text-gray-900">${tech.resolved}</td>
                <td class="px-4 py-4 text-sm">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${slaCompliance >= 90 ? 'bg-green-100 text-green-800' : slaCompliance >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                        ${slaCompliance}%
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

function generateDepartmentsTable(tickets) {
    // Calculate department statistics
    const deptStats = tickets.reduce((acc, ticket) => {
        const dept = ticket.department;
        
        if (!acc[dept]) {
            acc[dept] = {
                total: 0,
                totalTime: 0,
                resolvedCount: 0
            };
        }
        
        acc[dept].total++;
        
        if (ticket.resolved_at) {
            const createdTime = new Date(ticket.created_at);
            const resolvedTime = new Date(ticket.resolved_at);
            const diffHours = (resolvedTime - createdTime) / (1000 * 60 * 60);
            
            acc[dept].totalTime += diffHours;
            acc[dept].resolvedCount++;
        }
        
        return acc;
    }, {});
    
    const tbody = document.getElementById('departments-table');
    
    if (Object.keys(deptStats).length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                    Nenhum dado de departamento disponível
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = Object.entries(deptStats).map(([dept, stats]) => {
        const avgTime = stats.resolvedCount > 0 ? 
            Math.round(stats.totalTime / stats.resolvedCount) : 0;
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-4 text-sm text-gray-900">${dept}</td>
                <td class="px-4 py-4 text-sm text-gray-900">${stats.total}</td>
                <td class="px-4 py-4 text-sm text-gray-900">${avgTime}h</td>
            </tr>
        `;
    }).join('');
}

function applyReportFilters() {
    currentFilters = {
        start_date: document.getElementById('filter-start-date').value,
        end_date: document.getElementById('filter-end-date').value,
        status: document.getElementById('filter-status').value,
        priority: document.getElementById('filter-priority').value,
        department: document.getElementById('filter-department').value
    };
    
    loadReportData();
}

function clearReportFilters() {
    document.getElementById('filter-start-date').value = '';
    document.getElementById('filter-end-date').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-priority').value = '';
    document.getElementById('filter-department').value = '';
    
    currentFilters = {};
    initializeDateFilters();
    loadReportData();
}

async function exportReport() {
    try {
        showLoading();
        
        const params = new URLSearchParams(currentFilters);
        
        const response = await axios.get(`/api/reports/export?${params}`, {
            responseType: 'blob'
        });
        
        // Create download link
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `relatorio_chamados_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        
        showToast('Relatório exportado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Error exporting report:', error);
        showToast('Erro ao exportar relatório', 'error');
    } finally {
        hideLoading();
    }
}
</script>
{% endblock %}
