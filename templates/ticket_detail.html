{% extends "base.html" %}

{% block title %}Chamado #{{ ticket.id }} - TechSupport Pro{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex justify-between items-start mb-8">
        <div>
            <div class="flex items-center mb-2">
                <a href="{{ url_for('tickets') }}" class="text-tech-primary hover:text-tech-secondary mr-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">
                    Chamado #<span id="ticket-id">{{ ticket.id }}</span>
                </h1>
            </div>
            <p class="text-gray-600" id="ticket-title">{{ ticket.title }}</p>
        </div>
        
        {% if user.role in ['Técnico', 'Administrador'] %}
        <div class="flex space-x-3">
            <button onclick="openStatusModal()" class="bg-tech-accent hover:bg-tech-accent-dark text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-edit mr-2"></i>Atualizar Status
            </button>
        </div>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Ticket Details -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-info-circle text-tech-accent mr-2"></i>Detalhes do Chamado
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <p class="text-gray-900 bg-gray-50 p-3 rounded-lg" id="ticket-description">{{ ticket.description }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <p class="text-gray-900 bg-gray-50 p-3 rounded-lg" id="ticket-observations">
                            {{ ticket.observations if ticket.observations else 'Nenhuma observação' }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-comments text-tech-accent mr-2"></i>Chat do Chamado
                    </h3>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <span id="typing-indicator" class="hidden">
                            <i class="fas fa-circle-notch fa-spin mr-1"></i>Alguém está digitando...
                        </span>
                        <span id="online-users" class="hidden">
                            <i class="fas fa-circle text-green-400 mr-1"></i>Online
                        </span>
                    </div>
                </div>
                
                <div id="chat-messages" class="h-96 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 space-y-3">
                    <div class="flex justify-center">
                        <i class="fas fa-spinner fa-spin text-tech-primary text-xl"></i>
                    </div>
                </div>
                
                <form id="message-form" class="flex space-x-3">
                    <div class="flex-1">
                        <textarea id="message-input" rows="2" placeholder="Digite sua mensagem..." 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent resize-none"></textarea>
                    </div>
                    <div class="flex flex-col space-y-2">
                        {% if user.role in ['Técnico', 'Administrador'] %}
                        <label class="flex items-center text-sm text-gray-600">
                            <input type="checkbox" id="internal-message" class="mr-2">
                            Mensagem interna
                        </label>
                        {% endif %}
                        <button type="submit" class="bg-tech-primary hover:bg-tech-secondary text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- File Attachments -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-paperclip text-tech-accent mr-2"></i>Anexos
                    </h3>
                    <button onclick="openFileUploadModal()" class="bg-tech-accent hover:bg-tech-accent-dark text-white px-4 py-2 rounded-lg transition-colors text-sm">
                        <i class="fas fa-upload mr-2"></i>Adicionar Arquivo
                    </button>
                </div>
                
                <div id="attachments-list" class="space-y-2">
                    <!-- Attachments will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Status Card -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Status</h3>
                
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Prioridade:</span>
                        <span id="ticket-priority" class="px-2 py-1 text-xs font-semibold rounded-full"></span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span id="ticket-status" class="px-2 py-1 text-xs font-semibold rounded-full"></span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Departamento:</span>
                        <span id="ticket-department" class="text-gray-900"></span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">SLA:</span>
                        <span id="sla-status"></span>
                    </div>
                </div>
            </div>

            <!-- Assignment Card -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Atribuição</h3>
                
                <div class="space-y-3">
                    <div>
                        <span class="text-gray-600 block mb-1">Criado por:</span>
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-gray-400 mr-2"></i>
                            <span id="ticket-creator" class="text-gray-900"></span>
                        </div>
                    </div>
                    
                    <div>
                        <span class="text-gray-600 block mb-1">Atribuído para:</span>
                        <div class="flex items-center">
                            <i class="fas fa-user-cog text-gray-400 mr-2"></i>
                            <span id="ticket-assigned" class="text-gray-900"></span>
                        </div>
                    </div>
                </div>
                
                {% if user.role == 'Administrador' %}
                <button onclick="openAssignModal()" class="w-full mt-4 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors text-sm">
                    <i class="fas fa-user-plus mr-2"></i>Alterar Atribuição
                </button>
                {% endif %}
            </div>

            <!-- Timeline Card -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Cronologia</h3>
                
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between text-gray-600">
                        <span>Criado:</span>
                        <span id="ticket-created"></span>
                    </div>
                    
                    <div class="flex justify-between text-gray-600">
                        <span>Atualizado:</span>
                        <span id="ticket-updated"></span>
                    </div>
                    
                    <div class="flex justify-between text-gray-600" id="ticket-resolved-row" style="display: none;">
                        <span>Resolvido:</span>
                        <span id="ticket-resolved"></span>
                    </div>
                    
                    <div class="flex justify-between text-gray-600" id="ticket-closed-row" style="display: none;">
                        <span>Fechado:</span>
                        <span id="ticket-closed"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
{% if user.role in ['Técnico', 'Administrador'] %}
<div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Atualizar Status</h3>
            <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="status-form">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="new-status" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
                        <option value="Aberto">Aberto</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Resolvido">Resolvido</option>
                        <option value="Fechado">Fechado</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="new-observations" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent"
                              placeholder="Adicione observações sobre a atualização..."></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeStatusModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-tech-primary hover:bg-tech-secondary text-white rounded-lg transition-colors">
                    Atualizar
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- File Upload Modal -->
<div id="file-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Adicionar Arquivo</h3>
            <button onclick="closeFileUploadModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="file-upload-form" enctype="multipart/form-data">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Arquivo</label>
                    <input type="file" id="file-input" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tech-accent focus:border-tech-accent">
                    <p class="text-xs text-gray-500 mt-1">Tipos permitidos: PDF, DOC, XLS, ZIP, imagens (máx. 16MB)</p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeFileUploadModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-tech-primary hover:bg-tech-secondary text-white rounded-lg transition-colors">
                    <i class="fas fa-upload mr-2"></i>Enviar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ticketId = {{ ticket.id }};
let socket = null;
let typingTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    loadTicketDetails();
    loadMessages();
    initializeSocket();
    
    // Setup message form
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    
    messageForm.addEventListener('submit', sendMessage);
    
    // Typing indicator
    messageInput.addEventListener('input', function() {
        if (socket) {
            socket.emit('typing', { ticket_id: ticketId, is_typing: true });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing', { ticket_id: ticketId, is_typing: false });
            }, 1000);
        }
    });
    
    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
});

async function loadTicketDetails() {
    try {
        const response = await axios.get(`/api/tickets/${ticketId}`);
        const ticket = response.data;
        
        // Update ticket information
        document.getElementById('ticket-title').textContent = ticket.title;
        document.getElementById('ticket-description').textContent = ticket.description;
        document.getElementById('ticket-observations').textContent = ticket.observations || 'Nenhuma observação';
        document.getElementById('ticket-department').textContent = ticket.department;
        document.getElementById('ticket-creator').textContent = `${ticket.creator.username} (${ticket.creator.department})`;
        document.getElementById('ticket-assigned').textContent = ticket.assigned_to ? ticket.assigned_to.username : 'Não atribuído';
        
        // Update status badges
        updatePriorityBadge(ticket.priority);
        updateStatusBadge(ticket.status);
        updateSLAStatus(ticket);
        
        // Update timestamps
        document.getElementById('ticket-created').textContent = formatDateTime(ticket.created_at);
        document.getElementById('ticket-updated').textContent = formatDateTime(ticket.updated_at);
        
        if (ticket.resolved_at) {
            document.getElementById('ticket-resolved').textContent = formatDateTime(ticket.resolved_at);
            document.getElementById('ticket-resolved-row').style.display = 'flex';
        }
        
        if (ticket.closed_at) {
            document.getElementById('ticket-closed').textContent = formatDateTime(ticket.closed_at);
            document.getElementById('ticket-closed-row').style.display = 'flex';
        }
        
        // Update status modal
        const statusSelect = document.getElementById('new-status');
        const observationsTextarea = document.getElementById('new-observations');
        if (statusSelect) {
            statusSelect.value = ticket.status;
        }
        if (observationsTextarea) {
            observationsTextarea.value = ticket.observations || '';
        }
        
    } catch (error) {
        console.error('Error loading ticket details:', error);
        showToast('Erro ao carregar detalhes do chamado', 'error');
    }
}

async function loadMessages() {
    try {
        const response = await axios.get(`/api/tickets/${ticketId}/messages`);
        const messages = response.data.messages;
        
        renderMessages(messages);
    } catch (error) {
        console.error('Error loading messages:', error);
        showToast('Erro ao carregar mensagens', 'error');
    }
}

function renderMessages(messages) {
    const chatMessages = document.getElementById('chat-messages');
    
    if (messages.length === 0) {
        chatMessages.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-comment-slash text-3xl opacity-50 mb-2"></i>
                <p>Nenhuma mensagem ainda. Seja o primeiro a comentar!</p>
            </div>
        `;
        return;
    }
    
    chatMessages.innerHTML = messages.map(message => {
        const isOwn = message.author.id === {{ user.id }};
        const messageClass = isOwn ? 'ml-auto bg-tech-primary text-white' : 'mr-auto bg-gray-100 text-gray-900';
        const internalBadge = message.is_internal ? '<span class="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full ml-2">Interno</span>' : '';
        
        return `
            <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${messageClass}">
                    <div class="flex items-center mb-1">
                        <span class="text-sm font-medium ${isOwn ? 'text-white' : 'text-gray-900'}">${message.author.username}</span>
                        <span class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'} ml-2">${message.author.role}</span>
                        ${internalBadge}
                    </div>
                    <p class="text-sm ${isOwn ? 'text-white' : 'text-gray-900'}">${message.content}</p>
                    <p class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'} mt-1">${formatDateTime(message.created_at)}</p>
                </div>
            </div>
        `;
    }).join('');
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('message-input');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    const internalCheckbox = document.getElementById('internal-message');
    const isInternal = internalCheckbox ? internalCheckbox.checked : false;
    
    try {
        await axios.post(`/api/tickets/${ticketId}/messages`, {
            content: content,
            is_internal: isInternal
        });
        
        messageInput.value = '';
        messageInput.style.height = 'auto';
        if (internalCheckbox) internalCheckbox.checked = false;
        
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Erro ao enviar mensagem', 'error');
    }
}

function initializeSocket() {
    if (typeof io !== 'undefined') {
        socket = io();
        
        socket.on('connect', function() {
            console.log('Connected to socket server');
            socket.emit('join_ticket', { ticket_id: ticketId });
        });
        
        socket.on('new_message', function(data) {
            if (data.ticket_id === ticketId) {
                loadMessages(); // Reload messages
            }
        });
        
        socket.on('ticket_updated', function(data) {
            if (data.ticket_id === ticketId) {
                loadTicketDetails(); // Reload ticket details
                showToast(`Chamado atualizado por ${data.updated_by}`, 'info');
            }
        });
        
        socket.on('user_typing', function(data) {
            if (data.ticket_id === ticketId && data.user_id !== {{ user.id }}) {
                const indicator = document.getElementById('typing-indicator');
                if (data.is_typing) {
                    indicator.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-1"></i>${data.username} está digitando...`;
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }
        });
    }
}

function updatePriorityBadge(priority) {
    const badge = document.getElementById('ticket-priority');
    badge.textContent = priority;
    badge.className = 'px-2 py-1 text-xs font-semibold rounded-full ' + getPriorityClass(priority);
}

function updateStatusBadge(status) {
    const badge = document.getElementById('ticket-status');
    badge.textContent = status;
    badge.className = 'px-2 py-1 text-xs font-semibold rounded-full ' + getStatusClass(status);
}

function updateSLAStatus(ticket) {
    const slaStatus = document.getElementById('sla-status');
    
    if (!ticket.sla_deadline || ['Resolvido', 'Fechado'].includes(ticket.status)) {
        slaStatus.innerHTML = '<span class="text-gray-500">-</span>';
        return;
    }
    
    if (ticket.sla_violated) {
        slaStatus.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-exclamation-triangle mr-1"></i>Violado</span>';
    } else if (ticket.sla_near_violation) {
        slaStatus.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>Crítico</span>';
    } else {
        slaStatus.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Normal</span>';
    }
}

function getPriorityClass(priority) {
    const classes = {
        'Alta': 'bg-red-100 text-red-800',
        'Média': 'bg-yellow-100 text-yellow-800',
        'Baixa': 'bg-green-100 text-green-800'
    };
    return classes[priority] || 'bg-gray-100 text-gray-800';
}

function getStatusClass(status) {
    const classes = {
        'Aberto': 'bg-blue-100 text-blue-800',
        'Em Andamento': 'bg-orange-100 text-orange-800',
        'Resolvido': 'bg-green-100 text-green-800',
        'Fechado': 'bg-gray-100 text-gray-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

// Modal functions
function openStatusModal() {
    document.getElementById('status-modal').classList.remove('hidden');
}

function closeStatusModal() {
    document.getElementById('status-modal').classList.add('hidden');
}

function openFileUploadModal() {
    document.getElementById('file-upload-modal').classList.remove('hidden');
}

function closeFileUploadModal() {
    document.getElementById('file-upload-modal').classList.add('hidden');
    document.getElementById('file-upload-form').reset();
}

// Status form submission
const statusForm = document.getElementById('status-form');
if (statusForm) {
    statusForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newStatus = document.getElementById('new-status').value;
        const observations = document.getElementById('new-observations').value;
        
        try {
            showLoading();
            
            await axios.put(`/api/tickets/${ticketId}`, {
                status: newStatus,
                observations: observations
            });
            
            showToast('Status atualizado com sucesso!', 'success');
            closeStatusModal();
            loadTicketDetails();
            
        } catch (error) {
            console.error('Error updating status:', error);
            showToast('Erro ao atualizar status', 'error');
        } finally {
            hideLoading();
        }
    });
}

// File upload form submission
document.getElementById('file-upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('ticket_id', ticketId);
    
    try {
        showLoading();
        
        await axios.post('/api/upload', formData, {
            headers: {
                'Content-Type': 'multipart/form-data'
            }
        });
        
        showToast('Arquivo enviado com sucesso!', 'success');
        closeFileUploadModal();
        // TODO: Reload attachments list
        
    } catch (error) {
        console.error('Error uploading file:', error);
        showToast('Erro ao enviar arquivo', 'error');
    } finally {
        hideLoading();
    }
});

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>
{% endblock %}
